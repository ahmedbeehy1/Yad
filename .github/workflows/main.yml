name: Windows RDP Persistent Access

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Ú©Ø±Ø¯Ø§Ø±'
        required: true
        default: 'start'
        type: choice
        options:
          - start

env:
  RDP_USER: "Yad"
  RDP_PASS: "Ahmed1122$"

jobs:
  rdp-setup:
    runs-on: windows-latest
    if: ${{ inputs.action == 'start' }}  # ØªÛ•Ù†Ù‡Ø§ start Ù¾Ø´ØªÛŒÙˆØ§Ù†ÛŒ Ø¯Û•Ú©Ø§Øª

    steps:
      - name: Ú•ÛÚ©Ø®Ø³ØªÙ†ÛŒ RDP
        run: |
          # RDP Ú†Ø§Ù„Ø§Ú©Ú©Ø±Ø¯Ù†
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
          
          # NLA off (Ø¨Û† Ø³Ø§Ø¯Ú¯ÛŒ Ù„Û• ngrok/TailscaleØŒ Ø¦Û•Ú¯ÛŒÙ†Ø§ on Ø¨Ú©Û•)
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0
          
          # Firewall rule
          netsh advfirewall firewall add rule name="RDP" dir=in action=allow protocol=TCP localport=3389
          
          # Ø¨Û•Ú©Ø§Ø±Ù‡ÛÙ†Û•Ø± Ø¯Ø±ÙˆØ³ØªÚ©Ø±Ø¯Ù†
          $securePass = ConvertTo-SecureString "${{ env.RDP_PASS }}" -AsPlainText -Force
          New-LocalUser -Name "${{ env.RDP_USER }}" -Password $securePass -FullName "RDP User" -Description "GitHub Actions RDP" -AccountNeverExpires
          Add-LocalGroupMember -Group "Administrators" -Member "${{ env.RDP_USER }}"
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "${{ env.RDP_USER }}"
          
          # Multiple sessions
          Set-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server' -Name "fSingleSessionPerUser" -Value 0
          
          Restart-Service TermService -Force
          
          Write-Host "âœ… RDP Ø¦Ø§Ù…Ø§Ø¯Û•ÛŒÛ•"

      - name: Ø¯Ø§Ù†Ø§Ù†ÛŒ Tailscale Ø¨Û† IP Ù‡Û•Ù…ÛŒØ´Û•ÛŒÛŒ
        run: |
          $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi"
          $installer = "$env:TEMP\tailscale.msi"
          
          Invoke-WebRequest -Uri $tsUrl -OutFile $installer
          Start-Process msiexec.exe -ArgumentList "/i", "$installer", "/quiet", "/norestart" -Wait
          
          Start-Sleep -Seconds 15
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=rdp-${{ github.run_id }} --accept-routes=true
          
          Start-Sleep -Seconds 30
          $tsIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
          echo "TAILSCALE_IP=$tsIP" >> $env:GITHUB_ENV
          
          Write-Host "ğŸŒ Tailscale IP: $tsIP"

      - name: Ù†Ù…Ø§ÛŒØ´ÛŒ Ø²Ø§Ù†ÛŒØ§Ø±ÛŒ
        run: |
          Write-Host "========================================"
          Write-Host "ğŸš€ Windows RDP Ø¦Ø§Ù…Ø§Ø¯Û•ÛŒÛ•!"
          Write-Host "========================================"
          Write-Host "ğŸŒ IP Ù‡Û•Ù…ÛŒØ´Û•ÛŒÛŒ (Tailscale): $env:TAILSCALE_IP"
          Write-Host "ğŸ‘¤ Ø¨Û•Ú©Ø§Ø±Ù‡ÛÙ†Û•Ø±: ${{ env.RDP_USER }}"
          Write-Host "ğŸ” ÙˆØ´Û•ÛŒ Ù†Ù‡ÛÙ†ÛŒ: ${{ env.RDP_PASS }}"
          Write-Host "Ù¾Û†Ø±Øª: 3389"
          Write-Host ""
          Write-Host "ğŸ’¡ Ú•ÛÙ†Ù…Ø§ÛŒÛŒ: Tailscale Ø¯Ø§Ø¨Û•Ø²ÛÙ†Û• Ùˆ login Ø¨Ú©Û•ØŒ Ù¾Ø§Ø´Ø§Ù† RDP Ø¨Ú©Û• Ø¨Û• IPÙ€Û•Ú©Û•."
          Write-Host "âš ï¸  Ø¯Ø§ØªØ§Ú©Ø§Ù† Ø¯ÙˆØ§ÛŒ shutdown Ø¯Û•Ø³Ú•Ø¯Ø±ÛÙ†Û•ÙˆÛ• (hosted runner)."
          Write-Host "========================================"

      - name: Timer Ø¨Û† shutdown Ø®ÙˆØ¯Ú©Ø§Ø± (5 Ú©Ø§ØªÚ˜Ù…ÛØ±)
        run: |
          $endTime = (Get-Date).AddHours(5)
          $checkInterval = 360  # 5 Ø®ÙˆÙ„Û•Ú©
          
          while ((Get-Date) -lt $endTime) {
              $remaining = $endTime - (Get-Date)
              $hours = [math]::Floor($remaining.TotalHours)
              $minutes = $remaining.Minutes
              Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Ù…Ø§ÙˆÛ•ÛŒ Ù…Ø§Ø¨ÙˆÙˆÛ•: $hours Ú©Ø§ØªÚ˜Ù…ÛØ± Ùˆ $minutes Ø®ÙˆÙ„Û•Ú©"
              Start-Sleep -Seconds $checkInterval
          }
          
          Write-Host "ğŸ•’ Ú©Ø§Øª ØªÛ•ÙˆØ§Ùˆ Ø¨ÙˆÙˆ! Ø³ÛŒØ³ØªÙ… Ø¯Û•Ú©ÙˆÚ˜ÛØªÛ•ÙˆÛ•..."
          shutdown /s /t 30
