name: Windows RDP Full Persistent System

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Ú©Ø±Ø¯Ø§Ø±'
        required: true
        default: 'start'
        type: choice
        options:
        - start
        - restore
        - backup

env:
  VHD_PATH: "D:\\SystemBackup.vhdx"
  VHD_SIZE: "50GB"
  MOUNT_PATH: "C:\\"
  RDP_USER: "Yad"
  RDP_PASS: "Ahmed1122$"

jobs:
  persistent-system:
    runs-on: windows-latest
    
    steps:
      - name: Ú†ÛÚ©Ø±Ø¯Ù†ÛŒ Ø¯Ø±Ø§ÛŒÚ¤ÛŒ Ù‡Û•Ù…ÛŒØ´Û•ÛŒÛŒ
        run: |
          # Ù¾Ø´Ú©Ù†ÛŒÙ†ÛŒ Ø¦Û•Ú¯Û•Ø± Ø¯Ø±Ø§ÛŒÚ¤ÛŒ VHD Ø¨ÙˆÙˆÙ†ÛŒ Ù‡Û•Ø¨ÛØª
          $vhdExists = Test-Path "${{ env.VHD_PATH }}"
          
          if (-not $vhdExists -or "${{ github.event.inputs.action }}" -eq 'start') {
              Write-Host "ğŸš€ Ø¯Ø±ÙˆØ³ØªÚ©Ø±Ø¯Ù†ÛŒ Ø³ÛŒØ³ØªÙ…ÛÚ©ÛŒ Ù†ÙˆÛ..."
              
              # Ù¡. Ø¯Ø±ÙˆØ³ØªÚ©Ø±Ø¯Ù†ÛŒ VHD
              Write-Host "ğŸ’¾ Ø¯Ø±ÙˆØ³ØªÚ©Ø±Ø¯Ù†ÛŒ VHD..."
              New-VHD -Path "${{ env.VHD_PATH }}" -SizeBytes ${{ env.VHD_SIZE }} -Dynamic
              
              # Ù¢. Ù„Ú©Ø§Ù†Ø¯Ù†ÛŒ VHD
              $disk = Mount-VHD "${{ env.VHD_PATH }}" -Passthru
              $diskNumber = $disk.DiskNumber
              
              # Ù£. ÙØ±Ù…Ø§Øª Ú©Ø±Ø¯Ù† Ùˆ Ø¯Ø§Ù†Ø§Ù†ÛŒ Ø³ÛŒØ³ØªÙ…
              Write-Host "ğŸ”§ ÙØ±Ù…Ø§Øª Ú©Ø±Ø¯Ù†..."
              Initialize-Disk -DiskNumber $diskNumber
              New-Partition -DiskNumber $diskNumber -UseMaximumSize -AssignDriveLetter S
              Format-Volume -DriveLetter S -FileSystem NTFS -NewFileSystemLabel "PersistentSystem"
              
              # Ù¤. Ú©Û†Ù¾ÛŒÚ©Ø±Ø¯Ù†ÛŒ Ù‡Û•Ù…ÙˆÙˆ Ø³ÛŒØ³ØªÛ•Ù…Û•Ú©Û• Ø¨Û† VHD
              Write-Host "ğŸ“¦ Ú©Û†Ù¾ÛŒÚ©Ø±Ø¯Ù†ÛŒ Ù‡Û•Ù…ÙˆÙˆ Ø³ÛŒØ³ØªÛ•Ù…Û•Ú©Û•..."
              robocopy C:\ S:\ /MIR /COPYALL /R:0 /W:0 /NP /NFL /NDL /XF pagefile.sys /XD "Windows.old" "WinSxS"
              
              # Ù¥. Ø¯Ø²Ø§Ù†ÛŒ Ù„Û• Ø¯Ø±Ø§ÛŒÚ¤
              Dismount-VHD "${{ env.VHD_PATH }}"
              
          } elseif ("${{ github.event.inputs.action }}" -eq 'restore') {
              Write-Host "ğŸ”„ Ú¯Û•Ú•Ø§Ù†Ø¯Ù†Û•ÙˆÛ•ÛŒ Ø³ÛŒØ³ØªÙ… Ù„Û• VHD..."
              
              # Ù¡. Ù„Ú©Ø§Ù†Ø¯Ù†ÛŒ VHD
              Mount-VHD "${{ env.VHD_PATH }}"
              $disk = Get-Disk | Where-Object {$_.Location -like "*${{ env.VHD_PATH }}*"}
              
              # Ù¢. ÙØ±Ù…Ø§Øª Ú©Ø±Ø¯Ù†ÛŒ Ø¯Ø±Ø§ÛŒÚ¤ÛŒ Ø¦Û•Ø³ÚµÛŒ (C:) Ùˆ Ú¯ÙˆØ§Ø³ØªÙ†Û•ÙˆÛ•ÛŒ Ø¯Ø§ØªØ§
              Write-Host "ğŸ”„ Ú¯ÙˆØ§Ø³ØªÙ†Û•ÙˆÛ•ÛŒ Ù‡Û•Ù…ÙˆÙˆ Ø¯Ø§ØªØ§Ú©Ø§Ù†..."
              
              # ÛŒÛ•Ú©Û•Ù…: Ú©Û†Ù¾ÛŒÚ©Ø±Ø¯Ù†ÛŒ Ù‡Û•Ù…ÙˆÙˆ Ø¯Ø±Ø§ÛŒÚ¤Û•Ú©Ø§Ù†
              Get-Volume | Where-Object {$_.DriveLetter -ne $null} | ForEach-Object {
                  $sourceDrive = "$($_.DriveLetter):\"
                  $backupPath = "S:\Backup\$($_.DriveLetter)_Drive"
                  
                  if (Test-Path $sourceDrive) {
                      Write-Host "Ú©Û†Ù¾ÛŒÚ©Ø±Ø¯Ù†ÛŒ $sourceDrive..."
                      robocopy $sourceDrive $backupPath /MIR /COPYALL /R:0 /W:0 /NP /NFL /NDL
                  }
              }
              
              # Ø¯ÙˆÙˆÛ•Ù…: Ú¯ÙˆØ§Ø³ØªÙ†Û•ÙˆÛ• Ù„Û• VHD Ø¨Û† C:
              robocopy S:\ C:\ /MIR /COPYALL /R:0 /W:0 /NP /NFL /NDL
              
              # Ù£. Ø¯Ø²Ø§Ù†ÛŒ Ù„Û• Ø¯Ø±Ø§ÛŒÚ¤
              Dismount-VHD "${{ env.VHD_PATH }}"
          }
          
          Write-Host "âœ… Ø³ÛŒØ³ØªÛ•Ù…ÛŒ Ù‡Û•Ù…ÛŒØ´Û•ÛŒÛŒ Ø¦Ø§Ù…Ø§Ø¯Û•Ú©Ø±Ø§"

      - name: Ú•ÛÚ©Ø®Ø³ØªÙ†ÛŒ RDP
        run: |
          # Ù¡. RDP ÙØ¹Ø§Ù„ Ø¨Ú©Û•
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
            
          # Ù¢. Ù¾Ø§Ø±Ø§Ø³ØªÙ† Ù†Û•ÙˆÛØª
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0
            
          # Ù£. WallÛŒ Ø¦Ø§Ú¯Ø±
          netsh advfirewall firewall add rule name="RDP" dir=in action=allow protocol=TCP localport=3389
            
          # Ù¤. Ø¯Ø±ÙˆØ³ØªÚ©Ø±Ø¯Ù†ÛŒ Ø¨Û•Ú©Ø§Ø±Ù‡ÛÙ†Û•Ø±
          $securePass = ConvertTo-SecureString "${{ env.RDP_PASS }}" -AsPlainText -Force
          New-LocalUser -Name "${{ env.RDP_USER }}" -Password $securePass -AccountNeverExpires
          Add-LocalGroupMember -Group "Administrators" -Member "${{ env.RDP_USER }}"
          
          # Ù¥. Ú•ÛÚ©Ø®Ø³ØªÙ†ÛŒ Ø¨Û† Ù‡Û•Ù…ÙˆÙˆ Ø¨Û•Ú©Ø§Ø±Ù‡ÛÙ†Û•Ø±Û•Ú©Ø§Ù†
          Set-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server' -Name "fSingleSessionPerUser" -Value 0
            
          # Ù¦. Restart Ú©Ø±Ø¯Ù†
          Restart-Service TermService -Force
          
          Write-Host "âœ… RDP Ø¦Ø§Ù…Ø§Ø¯Û•Û•"

      - name: Ø¯Ø§Ù†Ø§Ù†ÛŒ Tailscale Ø¨Û† Ø¦Ø§ÛŒÙ¾ÛŒ Ù‡Û•Ù…ÛŒØ´Û•ÛŒÛŒ
        run: |
          # Ø¯Ø§Ù†Ø§Ù†ÛŒ Tailscale
          $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi"
          $installer = "$env:TEMP\tailscale.msi"
          
          Invoke-WebRequest -Uri $tsUrl -OutFile $installer
          Start-Process msiexec.exe -ArgumentList "/i", "$installer", "/quiet", "/norestart" -Wait
          
          # Ø¯Û•Ø³ØªÙ¾ÛÚ©Ø±Ø¯Ù†ÛŒ Tailscale
          Start-Sleep -Seconds 10
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=persistent-rdp-${{ github.run_id }} --accept-routes=true --advertise-exit-node
            
          # Ú†Ø§ÙˆÛ•Ú•ÙˆØ§Ù†ÛŒ Ø¨Û† IP
          Start-Sleep -Seconds 30
          $tsIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
          echo "TAILSCALE_IP=$tsIP" >> $env:GITHUB_ENV
          echo "PERSISTENT_IP=$tsIP" >> $env:GITHUB_ENV
          
          Write-Host "ğŸŒ Ø¦Ø§ÛŒÙ¾ÛŒ Ù‡Û•Ù…ÛŒØ´Û•ÛŒÛŒ: $tsIP"

      - name: System Backup Automation
        run: |
          # Ø¯Ø±ÙˆØ³ØªÚ©Ø±Ø¯Ù†ÛŒ Ø³Ú©Ø±ÛŒÙ¾ØªÛŒ Ø®Û†Ú©Ø§Ø±ÛŒ backup
          $backupScriptContent = @'
# Ø³Ú©Ø±ÛŒÙ¾ØªÛŒ Ø®Û†Ú©Ø§Ø±ÛŒ Ù‡Û•ÚµÚ¯Ø±ØªÙ†
$backupPath = "$env:TEMP\SystemBackup_$(Get-Date -Format 'yyyyMMdd_HHmmss').zip"
$excludePatterns = @(
    "*.tmp",
    "*.log", 
    "pagefile.sys",
    "hiberfil.sys",
    "swapfile.sys"
)

# Ù‡Û•ÚµÚ¯Ø±ØªÙ†ÛŒ Registry
Write-Host "ğŸ’¾ Ù‡Û•ÚµÚ¯Ø±ØªÙ†ÛŒ Registry..."
reg export HKLM\Software "$env:TEMP\registry_hklm.reg" /y
reg export HKCU "$env:TEMP\registry_hkcu.reg" /y

# Ù‡Û•ÚµÚ¯Ø±ØªÙ†ÛŒ Programs
Write-Host "ğŸ“¦ Ù‡Û•ÚµÚ¯Ø±ØªÙ†ÛŒ Programs..."
Get-WmiObject -Class Win32_Product | Select-Object Name, Version | Export-Csv "$env:TEMP\installed_programs.csv" -NoTypeInformation

# Ù‡Û•ÚµÚ¯Ø±ØªÙ†ÛŒ Services
Get-Service | Where-Object {$_.StartType -eq 'Automatic'} | Select-Object Name, DisplayName | Export-Csv "$env:TEMP\services.csv" -NoTypeInformation

# Ø¯Ø±ÙˆØ³ØªÚ©Ø±Ø¯Ù†ÛŒ System Image
Write-Host "ğŸ–¼ï¸ Ø¯Ø±ÙˆØ³ØªÚ©Ø±Ø¯Ù†ÛŒ System Image..."
$imagePath = "$env:TEMP\SystemImage.wim"
Dism /Capture-Image /ImageFile:"$imagePath" /CaptureDir:C:\ /Name:"FullSystem"

Write-Host "âœ… Ù‡Û•ÚµÚ¯Ø±ØªÙ† ØªÛ•ÙˆØ§Ùˆ Ø¨ÙˆÙˆ: $imagePath"
'@
          
          $backupScriptContent | Out-File -FilePath "C:\AutoBackup.ps1"
          
          # Ø¯Ø§Ù†Ø§Ù†ÛŒ Ø®Û†Ú©Ø§Ø±ÛŒ backup Ù‡Û•Ù…ÙˆÙˆ Ù¡Ù  Ø®ÙˆÙ„Û•Ú© Ø¬Ø§Ø±ÛÚ©
          $taskScriptContent = @'
$action = New-ScheduledTaskAction -Execute "powershell.exe" -Argument "-File C:\AutoBackup.ps1"
$trigger = New-ScheduledTaskTrigger -Once -At (Get-Date) -RepetitionInterval (New-TimeSpan -Minutes 10)
$principal = New-ScheduledTaskPrincipal -UserId "SYSTEM" -LogonType ServiceAccount -RunLevel Highest
Register-ScheduledTask -TaskName "AutoSystemBackup" -Action $action -Trigger $trigger -Principal $principal -Description "Auto backup every 10 minutes"
'@
          
          $taskScriptContent | Out-File -FilePath "C:\SetupTask.ps1"
          powershell -ExecutionPolicy Bypass -File "C:\SetupTask.ps1"

      - name: Ù†Ù…Ø§ÛŒØ´ÛŒ Ø²Ø§Ù†ÛŒØ§Ø±ÛŒ
        run: |
          Write-Host "========================================"
          Write-Host "ğŸš€ Windows RPD Ø¨Ø§ Ø³ÛŒØ³ØªÛ•Ù…ÛŒ Ù‡Û•Ù…ÛŒØ´Û•ÛŒÛŒ"
          Write-Host "========================================"
          Write-Host "ğŸŒ Ø¦Ø§ÛŒÙ¾ÛŒ Ù‡Û•Ù…ÛŒØ´Û•ÛŒÛŒ: $env:TAILSCALE_IP"
          Write-Host "ğŸ‘¤ Ø¨Û•Ú©Ø§Ø±Ù‡ÛÙ†Û•Ø±: ${{ env.RDP_USER }}"
          Write-Host "ğŸ” ÙˆØ´Û•ÛŒ Ù†Ù‡ÛÙ†ÛŒ: ${{ env.RDP_PASS }}"
          Write-Host ""
          Write-Host "âœ¨ ØªØ§ÛŒØ¨Û•ØªÙ…Û•Ù†Ø¯ÛŒÛ•Ú©Ø§Ù†:"
          Write-Host "â€¢ Ù‡Û•Ù…ÙˆÙˆ Ø¯Ø§ØªØ§ + Ø³ÛŒØ³ØªÛ•Ù… Ù‡Û•ÚµØ¯Û•Ú¯ÛŒØ±ÛØª"
          Write-Host "â€¢ ProgramÛ•Ú©Ø§Ù† Ù†Ø§Ø³Ú•ÛÙ†Û•ÙˆÛ•"
          Write-Host "â€¢ Ú•ÛÚ©Ø®Ø³ØªÙ†Û•Ú©Ø§Ù† Ù¾Ø§Ø±ÛØ²Ø±Ø§ÙˆÙ†"
          Write-Host "â€¢ ÙØ§ÛŒÙ„Û•Ú©Ø§Ù† Ø¯Û•Ù…ÛÙ†Ù†Û•ÙˆÛ•"
          Write-Host ""
          Write-Host "ğŸ’¡ Ú•ÛÙ†Ù…Ø§ÛŒÛŒ:"
          Write-Host "1. Ù‡Û•Ø±Ú†ÛŒ Ø¯Ø§ÛŒØ¨Ù†ÛØŒ Ø¯Û•Ù…ÛÙ†ÛØªÛ•ÙˆÛ•"
          Write-Host "2. ProgramÛ•Ú©Ø§Ù† Ø¯Ø§Ø¯Û•Ù†ÛØŒ Ø¯ÙˆÙˆØ¨Ø§Ø±Û• Ù†Ø§Ø¨Û Ø¯Ø§Ø¯Û•Ù†ÛÛŒØªÛ•ÙˆÛ•"
          Write-Host "3. Ú©Ø§ØªÛÚ© Ø¯ÙˆÙˆØ¨Ø§Ø±Û• Ø¯Û•Ø³ØªÙ¾ÛØ¯Û•Ú©Û•ÛŒØªØŒ Ù‡Û•Ù…ÙˆÙˆ Ø´ØªÛÚ© ÙˆÛ•Ú© Ù¾ÛØ´ØªØ±Û•"
          Write-Host "========================================"
          
          # Ø¯Ø§Ù†Ø§Ù†ÛŒ Ú©Ø§ØªÛŒ Ú©Û†ØªØ§ÛŒÛŒ
          $shutdownScriptContent = @'
$endTime = (Get-Date).AddHours(5)

while ((Get-Date) -lt $endTime) {
    $remaining = $endTime - (Get-Date)
    $hours = [math]::Floor($remaining.TotalHours)
    $minutes = [math]::Floor($remaining.TotalMinutes) % 60
    
    Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Ù…Ø§ÙˆÛ•ÛŒ Ù…Ø§Ø¨ÙˆÙˆÛ•: $hours Ú©Ø§ØªÚ˜Ù…ÛØ± $minutes Ø®ÙˆÙ„Û•Ú©"
    
    # BackupÛŒ Ø®Û†Ú©Ø§Ø± Ù‡Û•Ù…ÙˆÙˆ Ù¡Ù  Ø®ÙˆÙ„Û•Ú© Ø¬Ø§Ø±ÛÚ©
    if ((Get-Date).Minute % 10 -eq 0) {
        powershell -ExecutionPolicy Bypass -File C:\AutoBackup.ps1
    }
    
    Start-Sleep -Seconds 60
}

# Ú©Û†ØªØ§ÛŒÛŒ: BackupÛŒ Ú©Û†ØªØ§ÛŒÛŒ
Write-Host "ğŸ’¾ BackupÛŒ Ú©Û†ØªØ§ÛŒÛŒ..."
powershell -ExecutionPolicy Bypass -File C:\AutoBackup.ps1

Write-Host "ğŸ•’ Ú©Ø§ØªÛŒ ØªÛ•ÙˆØ§Ùˆ Ø¨ÙˆÙˆÙ†! $(Get-Date)"
Write-Host "Ø³ÛŒØ³ØªÛ•Ù… Ø®Û†Ú©Ø§Ø±Ø§Ù†Û• Ø¯Û•Ú©ÙˆÚ˜ÛØªÛ•ÙˆÛ•"
'@
          
          $shutdownScriptContent | Out-File -FilePath "C:\ShutdownTimer.ps1"
          Start-Process powershell -ArgumentList "-File C:\ShutdownTimer.ps1" -NoNewWindow

      - name: BackupÛŒ Ú©Û†ØªØ§ÛŒÛŒ Ù¾ÛØ´ Ú©ÙˆÚ˜Ø§Ù†Û•ÙˆÛ•
        run: |
          Write-Host "ğŸ’¾ Ù‡Û•ÚµÚ¯Ø±ØªÙ†ÛŒ Ú©Û†ØªØ§ÛŒÛŒ Ù¾ÛØ´ Ú©ÙˆÚ˜Ø§Ù†Û•ÙˆÛ•..."
          
          # Ù¡. Ù‡Û•ÚµÚ¯Ø±ØªÙ†ÛŒ Ù‡Û•Ù…ÙˆÙˆ Ø¨Û•Ú©Ø§Ø±Ù‡ÛÙ†Û•Ø±Ø§Ù†
          $usersPath = "C:\Users"
          $backupUsers = "$env:TEMP\Users_Backup_$(Get-Date -Format 'yyyyMMdd').zip"
          
          if (Test-Path $usersPath) {
              Compress-Archive -Path $usersPath -DestinationPath $backupUsers -CompressionLevel Optimal
              Write-Host "âœ… Ø¨Û•Ú©Ø§Ø±Ù‡ÛÙ†Û•Ø±Ø§Ù† Ù‡Û•ÚµÚ¯ÛŒØ±Ø§"
          }
          
          # Ù¢. Ù‡Û•ÚµÚ¯Ø±ØªÙ†ÛŒ Programs
          $programs = Get-WmiObject -Class Win32_Product | Select-Object Name, Version, InstallDate
          $programs | Export-Csv "$env:TEMP\Installed_Programs_Final.csv" -NoTypeInformation -Encoding UTF8
          
          # Ù£. Ù‡Û•ÚµÚ¯Ø±ØªÙ†ÛŒ Registry
          reg export HKLM\Software "$env:TEMP\HKLM_Software_Final.reg" /y
          reg export HKCU "$env:TEMP\HKCU_Final.reg" /y
          
          # Ù¤. Ø¯Ø±ÙˆØ³ØªÚ©Ø±Ø¯Ù†ÛŒ System Restore Point
          Checkpoint-Computer -Description "Pre-Shutdown Backup" -RestorePointType MODIFY_SETTINGS
          
          Write-Host "âœ… Ù‡Û•Ù…ÙˆÙˆ Ø¯Ø§ØªØ§Ú©Ø§Ù† Ù‡Û•ÚµÚ¯ÛŒØ±Ø§Ù†"
          Write-Host "ğŸ“Š Ú©Û†ÛŒ Ú¯Û•ÙˆØ±Û•ÛŒÛŒ:"
          Get-ChildItem "$env:TEMP\*_Backup_*", "$env:TEMP\*_Final.*" | ForEach-Object {
              $size = [math]::Round($_.Length / 1MB, 2)
              Write-Host "  - $($_.Name): $size MB"
          }
